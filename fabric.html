<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
  <title>VRP Templater - FabricJS</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <style>
    body {
      overflow-x: hidden;
    }
    .canvas-box {
      width: 100%;
      max-width: 100%;
      height: 600px;
      background-color: #f9f9f9;
      border: 1px solid #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    canvas {
      max-width: 100%;
      height: auto;
    }
    .live-preview-switch {
      position: absolute;
      top: 10px;
      right: 10px;
    }
  </style>
</head>
<body>
  <div class="container-fluid mt-4">
    <h2 class="text-center mb-4">VRP Templater (Fabric.js)</h2>

    <div class="row">
      <!-- Right column: Form inputs -->
      <div class="col-lg-6 col-md-6">
        <div class="mb-3">
          <label class="form-label">Name:</label>
          <input class="form-control" id="nameInput">
        </div>
        <div class="mb-3">
          <label class="form-label">DOB:</label>
          <input class="form-control" id="dobInput">
        </div>
        <div class="mb-3">
          <label class="form-label">VRP #:</label>
          <input class="form-control" id="vrpInput">
        </div>
        <div class="mb-3">
          <label class="form-label">Doctor:</label>
          <input class="form-control" id="drInput">
        </div>
        <div class="mb-3">
          <button class="btn btn-primary" onclick="generateImage()">Generate</button>
          <a id="downloadLink" class="btn btn-success ms-2" style="display:none" download="VRP_Wristband.png">Download Image</a>
        </div>
      </div>

            <!-- Left column: Canvas -->
      <div class="col-lg-6 col-md-6">
        <div class="canvas-box">
          <canvas id="canvas" width="550" height="300"></canvas>
          <div class="form-check form-switch live-preview-switch">
            <input class="form-check-input" type="checkbox" id="livePreviewToggle">
            <label class="form-check-label" for="livePreviewToggle">Live Preview</label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const canvas = new fabric.Canvas('canvas');
    const liveToggle = document.getElementById('livePreviewToggle');

    fabric.Image.fromURL('templates_images/PatientIDEmpty.png', function(img) {
      const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
      img.set({
        scaleX: scale,
        scaleY: scale,
        originX: 'left',
        originY: 'top',
        left: 0,
        top: 0
      });
      canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
    });

    function drawCenteredText(text, centerX, centerY, fontSize, color) {
      const textObj = new fabric.Text(text, {
        left: centerX,
        top: centerY,
        fontSize: fontSize,
        fill: color,
        originX: 'center',
        originY: 'center'
      });
      canvas.add(textObj);
    }

    function generateImage() {
      canvas.getObjects('text').forEach(obj => canvas.remove(obj));

      const name = document.getElementById('nameInput').value;
      const dob = document.getElementById('dobInput').value;
      const vrp = document.getElementById('vrpInput').value;
      const dr = document.getElementById('drInput').value;

      drawCenteredText(name, 275, 167, 30, 'black');
      drawCenteredText(dob, 275, 190, 16, 'black');
      drawCenteredText(vrp, 275, 210, 16, 'black');
      drawCenteredText(dr, 275, 235, 20, 'black');

      canvas.renderAll();

      const dataURL = canvas.toDataURL({ format: 'png' });
      const link = document.getElementById('downloadLink');
      link.href = dataURL;
      link.style.display = 'inline';
    }

    // Attach live preview listeners
    document.querySelectorAll('#nameInput, #dobInput, #vrpInput, #drInput').forEach(input => {
      input.addEventListener('input', () => {
        if (liveToggle.checked) {
          generateImage();
        }
      });
    });
  </script>
</body>
</html>
