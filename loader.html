<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>VRP Templater - Loader</title>
  <link href="style.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
</head>
<body>
  <div class="container mt-4">
    <h2 class="text-center mb-4">VRP Templater (Load Template)</h2>
    <div class="row">

      <!-- Left Column: Template selector + dynamic inputs -->
      <div class="col-md-4">
        <div class="mb-3">
          <label class="form-label">Choose Template:</label>
          <select class="form-select" id="templateSelector" onchange="loadTemplate()">
            <option disabled selected value="">-- Select Template --</option>
          </select>
        </div>

        <form id="dynamicFields"></form>

        <div class="mt-4">
          <button class="btn btn-primary" onclick="generateImage()">Generate</button>
          <button class="btn btn-success ms-2" onclick="downloadImage()">Download Image</button>
        </div>
      </div>

      <!-- Right Column: Canvas display -->
      <div class="col-md-8">
        <div class="canvas-box">
          <canvas id="canvas"></canvas>
          <div class="form-check form-switch live-preview-switch">
            <input class="form-check-input" type="checkbox" id="livePreviewToggle">
            <label class="form-check-label" for="livePreviewToggle">Live Preview</label>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const canvas = new fabric.Canvas('canvas');
const liveToggle = document.getElementById('livePreviewToggle');

function loadTemplate() {
  const selectedFile = document.getElementById('templateSelector').value;
  if (!selectedFile) return;

  fetch('templates_json/' + selectedFile)
    .then(response => response.json())
    .then(template => {
      const bgImg = template.backgroundImage?.src;
      if (!bgImg) return;

      fabric.Image.fromURL(bgImg, function(img) {
        const maxW = 800;
        const maxH = 1000;
        const scale = Math.min(maxW / img.width, maxH / img.height);

        // Resize canvas to match scaled background
        canvas.setWidth(img.width * scale);
        canvas.setHeight(img.height * scale);

        img.set({
          scaleX: scale,
          scaleY: scale,
          originX: 'left',
          originY: 'top',
          left: 0,
          top: 0
        });

        canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));

        canvas.loadFromJSON(template, () => {
          canvas.getObjects().forEach(obj => {
            if (obj.type !== 'image') {
              obj.setCoords();
            }
          });

          canvas.renderAll();
          populateInputFields();
        }, function(o, object) {
          if (object.type === 'text') {
            object.selectable = true;
          }
        });
      });
    });
}

function populateInputFields() {
  const form = document.getElementById('dynamicFields');
  form.innerHTML = '';
  canvas.getObjects('text').forEach(obj => {
    const label = document.createElement('label');
    label.className = 'form-label mt-2';
    label.innerText = obj.label || 'Field';

    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'form-control';
    input.value = obj.text || '';

    input.addEventListener('input', () => {
      obj.text = input.value;
      canvas.renderAll();
    });

    form.appendChild(label);
    form.appendChild(input);
  });
}

function generateImage() {
  const textObjects = canvas.getObjects('text');
  document.querySelectorAll('#dynamicFields input').forEach((input, index) => {
    if (textObjects[index]) {
      textObjects[index].text = input.value;
    }
  });
  canvas.renderAll();
}

function downloadImage() {
  const dataURL = canvas.toDataURL({ format: 'png', multiplier: 4 });
  const link = document.createElement('a');
  link.href = dataURL;
  link.download = 'filled_template.png';
  link.click();
}

fetch('templates_json/templates.json')
  .then(res => res.json())
  .then(files => {
    const selector = document.getElementById('templateSelector');
    files.forEach(file => {
      const option = document.createElement('option');
      option.value = file;
      option.textContent = file.replace('.json', '').replace(/_/g, ' ');
      selector.appendChild(option);
    });
  })
  .catch(err => {
    console.error("Failed to load template list:", err);
  });

document.getElementById('livePreviewToggle').addEventListener('change', () => {
  document.querySelectorAll('#dynamicFields input').forEach(input => {
    input.dispatchEvent(new Event('input'));
  });
});
</script>


</body>
</html>
